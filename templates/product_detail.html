{% extends 'base.html' %}
{% load static %}
{% load dict_extras %}
{% block title %}{{ product.name }} - {{ product.category.name }}{% endblock %}

{% block meta_description %}{{ product.short_description|default:product.description|truncatewords:30 }}{% endblock %}

{% block extra_css %}
<!-- Include cart styles -->
{% include '_cart_scripts.html' %}
{% endblock %}

{% block content %}

<style>
.product-gallery {
    position: sticky;
    top: 100px;
}

.main-image-container {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
    position: relative;
}

.main-product-image {
    width: 100%;
    height: 400px;
    object-fit: contain;
    background: white;
    cursor: zoom-in;
}

.thumbnail-images {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    overflow-x: auto;
    padding-bottom: 5px;
}

.thumbnail-img {
    width: 70px;
    height: 70px;
    object-fit: cover;
    border: 2px solid transparent;
    border-radius: 4px;
    cursor: pointer;
    transition: border-color 0.3s;
    flex-shrink: 0;
}

.thumbnail-img.active,
.thumbnail-img:hover {
    border-color: #28a745;
}

.product-info {
    padding: 20px 0;
}

.product-title {
    font-size: 1.8rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 10px;
}

.farmer-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
}

.farmer-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 600;
}

.farmer-link:hover {
    text-decoration: underline;
}

.rating-section {
    display: flex;
    align-items: center;
    gap: 15px;
    margin: 15px 0;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.stars {
    color: #ffc107;
}

.stars .far {
    color: #e9ecef;
}

.rating-text {
    color: #6c757d;
    font-size: 0.9rem;
}

.price-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
    border-left: 4px solid #28a745;
}

.current-price {
    font-size: 2.2rem;
    font-weight: 700;
    color: #28a745;
}

.original-price {
    font-size: 1.2rem;
    color: #6c757d;
    text-decoration: line-through;
    margin-left: 10px;
}

.discount-badge {
    background: #dc3545;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-left: 10px;
}

.savings-info {
    color: #28a745;
    font-weight: 600;
    margin-top: 8px;
    font-size: 0.9rem;
}

.stock-status {
    margin: 15px 0;
}

.stock-badge {
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin: 25px 0;
    flex-wrap: wrap;
}

.btn-add-cart {
    flex: 1;
    padding: 12px 20px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-width: 200px;
}

.btn-whatsapp {
    background: #25d366;
    border-color: #25d366;
    color: white;
    padding: 12px 20px;
    font-weight: 600;
    text-decoration: none;
    border-radius: 5px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
    min-width: 200px;
    justify-content: center;
}

.btn-whatsapp:hover {
    background: #1da851;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
}

.quantity-selector {
    display: flex;
    align-items: center;
    gap: 15px;
    margin: 20px 0;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
}

.quantity-controls {
    display: flex;
    align-items: center;
    gap: 5px;
    border: 1px solid #ddd;
    border-radius: 6px;
    overflow: hidden;
}

.quantity-btn {
    border: none;
    background: #fff;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.3s;
}

.quantity-btn:hover {
    background: #e9ecef;
}

.quantity-input {
    width: 80px;
    text-align: center;
    padding: 8px;
    border: none;
    border-left: 1px solid #ddd;
    border-right: 1px solid #ddd;
    height: 40px;
}

.product-attributes {
    margin: 20px 0;
}

.attribute-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.attribute-row:last-child {
    border-bottom: none;
}

.delivery-info {
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}

.delivery-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.delivery-feature {
    display: flex;
    align-items: center;
    gap: 10px;
}

.tabs-section {
    margin: 40px 0;
}

.nav-tabs {
    border-bottom: 2px solid #e9ecef;
}

.nav-tabs .nav-link {
    color: #495057;
    font-weight: 600;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 15px 25px;
    margin-bottom: -2px;
}

.nav-tabs .nav-link.active {
    color: #28a745;
    border-bottom-color: #28a745;
    background: none;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #28a745;
    color: #28a745;
}

.tab-pane {
    padding: 30px 0;
}

.product-description {
    line-height: 1.8;
    color: #495057;
}

.farmer-profile-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.review-item {
    border-bottom: 1px solid #eee;
    padding: 25px 0;
}

.review-item:last-child {
    border-bottom: none;
}

.review-header {
    display: flex;
    justify-content: between;
    align-items: start;
    gap: 15px;
    margin-bottom: 10px;
}

.reviewer-info {
    flex: 1;
}

.review-rating {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.review-date {
    color: #6c757d;
    font-size: 0.85rem;
}

.rating-breakdown {
    margin: 20px 0;
}

.rating-row {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 10px;
}

.rating-label {
    min-width: 60px;
    font-size: 0.9rem;
}

.rating-progress {
    flex: 1;
    height: 10px;
    background: #e9ecef;
    border-radius: 5px;
    overflow: hidden;
}

.rating-progress-bar {
    height: 100%;
    background: #ffc107;
    transition: width 0.6s ease;
}

.rating-count {
    min-width: 40px;
    text-align: right;
    font-size: 0.9rem;
    color: #6c757d;
}

.related-products {
    margin: 50px 0;
}

/* Use product list styling for uniform appearance */
.product-item {
    transition: all 0.3s ease;
    height: 100%;
    text-decoration: none;
    color: inherit;
    background: #fff;
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.product-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    color: inherit;
    text-decoration: none;
}

@media (max-width: 768px) {
    .main-product-image {
        height: 300px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .btn-add-cart,
    .btn-whatsapp {
        min-width: 100%;
    }
    
    .current-price {
        font-size: 1.8rem;
    }
    
    .product-title {
        font-size: 1.4rem;
    }
    
    .quantity-selector {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .delivery-features {
        grid-template-columns: 1fr;
    }
    
    .nav-tabs .nav-link {
        padding: 12px 15px;
        font-size: 0.9rem;
    }
    
    .review-header {
        flex-direction: column;
        align-items: start;
        gap: 10px;
    }
}
</style>

    <!-- Page Header -->
    <div class="container-fluid page-header mb-5 wow fadeIn" data-wow-delay="0.1s">
        <div class="container">
            <nav aria-label="breadcrumb animated slideInDown">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a class="text-body" href="{% url 'home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a class="text-body" href="{% url 'product_list' %}">Products</a></li>
                    <li class="breadcrumb-item"><a class="text-body" href="{% url 'product_list' %}?category={{ product.category.slug }}">{{ product.category.name }}</a></li>
                    {% if product.subcategory %}
                    <li class="breadcrumb-item"><a class="text-body" href="{% url 'product_list' %}?subcategory={{ product.subcategory.slug }}">{{ product.subcategory.name }}</a></li>
                    {% endif %}
                    <li class="breadcrumb-item text-dark active" aria-current="page">{{ product.name|truncatechars:40 }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="container-xxl py-5">
        <div class="container">
            <div class="row">
                <!-- Product Images -->
                <div class="col-lg-5">
                    <div class="product-gallery wow fadeInUp" data-wow-delay="0.1s">
                        <div class="main-image-container">
                            <img id="mainProductImage" class="main-product-image" 
                                src="{% if main_image %}{{ main_image.image.url }}{% else %}{% static 'img/product-placeholder.jpg' %}{% endif %}" 
                                alt="{{ product.name }}"
                                onclick="openImageModal(this.src)">
                                
                            {% if savings_percentage > 0 %}
                            <div class="position-absolute top-0 start-0 m-3 py-2 px-3 bg-danger text-white rounded">
                                -{{ savings_percentage }}% OFF
                            </div>
                            {% endif %}
                            
                            {% if product.is_organic %}
                            <div class="position-absolute top-0 end-0 m-3">
                                <span class="badge bg-success p-2">
                                    <i class="fas fa-leaf me-1"></i>Organic
                                </span>
                            </div>
                            {% endif %}
                            
                            {% if product.is_featured %}
                            <div class="position-absolute bottom-0 start-0 m-3">
                                <span class="badge bg-warning text-dark p-2">
                                    <i class="fas fa-star me-1"></i>Featured
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if product_images.count > 1 %}
                        <div class="thumbnail-images">
                            {% for image in product_images %}
                            <img class="thumbnail-img {% if forloop.first %}active{% endif %}" 
                                 src="{{ image.image.url }}" 
                                 alt="{{ product.name }}"
                                 onclick="changeMainImage('{{ image.image.url }}', this)">
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Product Info -->
                <div class="col-lg-7">
                    <div class="product-info wow fadeInUp" data-wow-delay="0.3s">
                        <h1 class="product-title">{{ product.name }}</h1>
                        
                        <!-- Farmer Information -->
                        <div class="farmer-info">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-1">
                                        <i class="fas fa-user-tie text-primary me-2"></i>
                                        <a href="#" class="farmer-link">{{ product.farmer.farm_name }}</a>
                                    </h6>
                                    <p class="mb-0 text-muted small">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        {{ product.farmer.full_address }}
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    {% if product.farmer.rating > 0 %}
                                    <div class="rating-stars">
                                        {% for i in "12345"|make_list %}
                                            {% if forloop.counter <= product.farmer.rating %}
                                            <i class="fas fa-star text-warning"></i>
                                            {% else %}
                                            <i class="far fa-star text-warning"></i>
                                            {% endif %}
                                        {% endfor %}
                                        <small class="text-muted ms-1">({{ product.farmer.total_reviews }})</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Product Details -->
                        <div class="product-attributes">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="attribute-row">
                                        <span class="fw-semibold">SKU:</span>
                                        <span>{{ product.sku }}</span>
                                    </div>
                                    <div class="attribute-row">
                                        <span class="fw-semibold">Category:</span>
                                        <span>{{ product.category.name }}</span>
                                    </div>
                                    {% if product.subcategory %}
                                    <div class="attribute-row">
                                        <span class="fw-semibold">Type:</span>
                                        <span>{{ product.subcategory.name }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <div class="attribute-row">
                                        <span class="fw-semibold">Unit:</span>
                                        <span>{{ product.get_unit_display }}</span>
                                    </div>
                                    {% if product.variety %}
                                    <div class="attribute-row">
                                        <span class="fw-semibold">Variety:</span>
                                        <span>{{ product.variety }}</span>
                                    </div>
                                    {% endif %}
                                    {% if product.quality_grade %}
                                    <div class="attribute-row">
                                        <span class="fw-semibold">Grade:</span>
                                        <span>{{ product.get_quality_grade_display }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Stock Status -->
                        <div class="stock-status">
                            <div class="stock-badge bg-{{ stock_info.class }} text-white">
                                <i class="fas fa-{{ stock_info.icon }}"></i>
                                {{ stock_info.text }}
                            </div>
                            {% if product.available_quantity > 0 and product.available_quantity <= product.low_stock_threshold %}
                            <small class="text-warning d-block mt-2">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Hurry! Only {{ product.available_quantity }} {{ product.get_unit_display }} left in stock
                            </small>
                            {% endif %}
                        </div>

                        <!-- Price Section -->
                        <div class="price-section">
                            <div class="d-flex align-items-center flex-wrap">
                                <span class="current-price">KSh {{ product.selling_price|floatformat:2 }}</span>
                                {% if product.discount_price %}
                                <span class="original-price">KSh {{ product.price|floatformat:2 }}</span>
                                <span class="discount-badge">-{{ savings_percentage }}%</span>
                                {% endif %}
                            </div>
                            {% if savings_amount > 0 %}
                            <div class="savings-info">
                                <i class="fas fa-tag me-1"></i>You save KSh {{ savings_amount|floatformat:2 }}
                            </div>
                            {% endif %}
                            <small class="text-muted">Price per {{ product.get_unit_display }}</small>
                            
                            {% if product.minimum_order > 1 %}
                            <div class="mt-2">
                                <small class="text-info">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Minimum order: {{ product.minimum_order }} {{ product.get_unit_display }}
                                </small>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Quantity and Actions -->
                        {% if product.is_in_stock %}
                        <div class="quantity-selector">
                            <label for="quantity" class="fw-semibold">Quantity:</label>
                            <div class="quantity-controls">
                                <button type="button" class="quantity-btn" onclick="decreaseQuantity()">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" id="quantity" class="quantity-input" value="{{ product.minimum_order|default:1 }}" 
                                       min="{{ product.minimum_order|default:1 }}" max="{{ product.available_quantity }}">
                                <button type="button" class="quantity-btn" onclick="increaseQuantity()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <small class="text-muted">{{ product.available_quantity }} {{ product.get_unit_display }} available</small>
                        </div>

                        <div class="action-buttons">
                            <form method="post" action="{% url 'add_to_cart' product.id %}" class="d-inline flex-fill">
                                {% csrf_token %}
                                <input type="hidden" name="product_id" value="{{ product.id }}">
                                <input type="hidden" name="quantity" id="form-quantity" value="{{ product.minimum_order|default:1 }}">
                                <button type="submit" class="btn btn-success btn-add-cart w-100">
                                    <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                                </button>
                            </form>
                            <a href="https://wa.me/{{ product.farmer.mpesa_number|slice:'1:' }}?text={{ whatsapp_message|urlencode }}" 
                               class="btn-whatsapp" target="_blank">
                                <i class="fab fa-whatsapp"></i>
                                WhatsApp Order
                            </a>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            This product is currently {{ product.get_stock_status_display|lower }}. 
                            {% if product.stock_status == 'pre_order' %}
                            You can place a pre-order for future delivery.
                            {% else %}
                            Contact the farmer for availability.
                            {% endif %}
                        </div>
                        
                        {% if product.stock_status == 'pre_order' and product.is_available_for_preorder %}
                        <div class="action-buttons">
                            <button class="btn btn-outline-primary btn-add-cart w-100">
                                <i class="fas fa-clock me-2"></i>Pre-Order Now
                            </button>
                        </div>
                        {% endif %}
                        
                        <a href="https://wa.me/{{ product.farmer.mpesa_number|slice:'1:' }}?text=Hi! I'm interested in {{ product.name }}. When will it be available?" 
                           class="btn btn-outline-success mt-3">
                            <i class="fab fa-whatsapp me-2"></i>Ask about availability
                        </a>
                        {% endif %}

                        <!-- Delivery Info -->
                        <div class="delivery-info">
                            <h6 class="mb-3">
                                <i class="fas fa-truck text-primary me-2"></i>Delivery Information
                            </h6>
                            <div class="delivery-features">
                                <div class="delivery-feature">
                                    <i class="fas fa-clock text-success"></i>
                                    <span>Same day delivery available</span>
                                </div>
                                <div class="delivery-feature">
                                    <i class="fas fa-shield-alt text-primary"></i>
                                    <span>100% quality guarantee</span>
                                </div>
                                <div class="delivery-feature">
                                    <i class="fas fa-undo text-warning"></i>
                                    <span>Easy returns within 7 days</span>
                                </div>
                                <div class="delivery-feature">
                                    <i class="fas fa-phone text-info"></i>
                                    <span>24/7 customer support</span>
                                </div>
                            </div>
                        </div>

                        <!-- Harvest Information -->
                        {% if product.harvest_date or product.expiry_date %}
                        <div class="alert alert-light border-left-success mt-3">
                            <h6 class="alert-heading">
                                <i class="fas fa-calendar-alt text-success me-2"></i>Freshness Information
                            </h6>
                            {% if product.harvest_date %}
                            <p class="mb-1">
                                <strong>Harvest Date:</strong> {{ product.harvest_date|date:"F d, Y" }}
                            </p>
                            {% endif %}
                            {% if product.expiry_date %}
                            <p class="mb-0">
                                <strong>Best Before:</strong> {{ product.expiry_date|date:"F d, Y" }}
                            </p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Product Details Tabs -->
            <div class="tabs-section wow fadeInUp" data-wow-delay="0.5s">
                <ul class="nav nav-tabs" id="productTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="description-tab" data-bs-toggle="tab" 
                                data-bs-target="#description" type="button" role="tab">
                            <i class="fas fa-info-circle me-2"></i>Description
                        </button>
                    </li>
                    {% if total_reviews > 0 %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" 
                                data-bs-target="#reviews" type="button" role="tab">
                            <i class="fas fa-star me-2"></i>Reviews ({{ total_reviews }})
                        </button>
                    </li>
                    {% endif %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="farmer-tab" data-bs-toggle="tab" 
                                data-bs-target="#farmer" type="button" role="tab">
                            <i class="fas fa-user-tie me-2"></i>About Farmer
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="productTabsContent">
                    <!-- Description Tab -->
                    <div class="tab-pane fade show active" id="description" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>Product Description</h5>
                                <div class="product-description">
                                    {{ product.description|linebreaks }}
                                </div>
                                
                                {% if product.farming_method %}
                                <h6 class="mt-4">Farming Method</h6>
                                <p>{{ product.farming_method }}</p>
                                {% endif %}
                                
                                {% if product.short_description %}
                                <div class="alert alert-info mt-4">
                                    <strong>Quick Summary:</strong> {{ product.short_description }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-clipboard-list me-2"></i>Product Specifications
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm table-borderless">
                                            <tr>
                                                <td><strong>SKU:</strong></td>
                                                <td>{{ product.sku }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Category:</strong></td>
                                                <td>{{ product.category.name }}</td>
                                            </tr>
                                            {% if product.subcategory %}
                                            <tr>
                                                <td><strong>Subcategory:</strong></td>
                                                <td>{{ product.subcategory.name }}</td>
                                            </tr>
                                            {% endif %}
                                            <tr>
                                                <td><strong>Unit:</strong></td>
                                                <td>{{ product.get_unit_display }}</td>
                                            </tr>
                                            {% if product.variety %}
                                            <tr>
                                                <td><strong>Variety:</strong></td>
                                                <td>{{ product.variety }}</td>
                                            </tr>
                                            {% endif %}
                                            <tr>
                                                <td><strong>Grade:</strong></td>
                                                <td>{{ product.get_quality_grade_display }}</td>
                                            </tr>
                                            {% if product.is_organic %}
                                            <tr>
                                                <td colspan="2">
                                                    <span class="badge bg-success w-100">
                                                        <i class="fas fa-leaf me-1"></i>Certified Organic
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reviews Tab -->
                    {% if total_reviews > 0 %}
                    <div class="tab-pane fade" id="reviews" role="tabpanel">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h2 class="display-4 text-warning mb-2">{{ avg_rating }}</h2>
                                        <div class="stars mb-2 fs-5">
                                            {% for i in "12345" %}
                                                {% if forloop.counter0 < stars_full %}
                                                    <i class="fas fa-star"></i>
                                                {% elif forloop.counter0 < stars_full|add:stars_half %}
                                                    <i class="fas fa-star-half-alt"></i>
                                                {% else %}
                                                    <i class="far fa-star"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <p class="text-muted">Based on {{ total_reviews }} review{{ total_reviews|pluralize }}</p>
                                    </div>
                                </div>
                                
                                <div class="rating-breakdown mt-4">
                                    <h6>Rating Breakdown</h6>
                                    {% for i in "54321" %}
                                    {% with rating=forloop.counter %}
                                    <div class="rating-row">
                                        <span class="rating-label">{{ rating }} star{{ rating|pluralize }}</span>
                                        <div class="rating-progress">
                                            <div class="rating-progress-bar" style="width: {{ rating_percentages|get_item:rating|default:0 }}%"></div>
                                        </div>
                                        <span class="rating-count">{{ rating_percentages|get_item:rating|default:0 }}%</span>
                                    </div>
                                    {% endwith %}
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="col-md-8">
                                <h5 class="mb-4">Customer Reviews</h5>
                                <div id="reviewsContainer">
                                    {% for review in reviews %}
                                    <div class="review-item">
                                        <div class="review-header">
                                            <div class="reviewer-info">
                                                <div class="review-rating">
                                                    <div class="stars">
                                                        {% for i in "12345" %}
                                                            {% if forloop.counter <= review.rating %}
                                                                <i class="fas fa-star"></i>
                                                            {% else %}
                                                                <i class="far fa-star"></i>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    <strong>{{ review.buyer.user.get_full_name|default:review.buyer.user.username }}</strong>
                                                </div>
                                                <div class="review-date">{{ review.created_at|date:"F d, Y" }}</div>
                                            </div>
                                        </div>
                                        {% if review.title %}
                                        <h6 class="mb-2">{{ review.title }}</h6>
                                        {% endif %}
                                        <p class="mb-0">{{ review.comment }}</p>
                                        
                                        {% if review.product_quality or review.communication or review.packaging %}
                                        <div class="mt-3">
                                            <small class="text-muted">Additional ratings:</small>
                                            <div class="row text-center mt-2">
                                                {% if review.product_quality %}
                                                <div class="col-4">
                                                    <small class="d-block text-muted">Quality</small>
                                                    <div class="stars small">
                                                        {% for i in "12345" %}
                                                            {% if forloop.counter <= review.product_quality %}
                                                                <i class="fas fa-star"></i>
                                                            {% else %}
                                                                <i class="far fa-star"></i>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if review.communication %}
                                                <div class="col-4">
                                                    <small class="d-block text-muted">Communication</small>
                                                    <div class="stars small">
                                                        {% for i in "12345" %}
                                                            {% if forloop.counter <= review.communication %}
                                                                <i class="fas fa-star"></i>
                                                            {% else %}
                                                                <i class="far fa-star"></i>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if review.packaging %}
                                                <div class="col-4">
                                                    <small class="d-block text-muted">Packaging</small>
                                                    <div class="stars small">
                                                        {% for i in "12345" %}
                                                            {% if forloop.counter <= review.packaging %}
                                                                <i class="fas fa-star"></i>
                                                            {% else %}
                                                                <i class="far fa-star"></i>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                {% if total_reviews > 5 %}
                                <div class="text-center mt-4">
                                    <button class="btn btn-outline-primary" onclick="loadMoreReviews()">
                                        <i class="fas fa-chevron-down me-2"></i>Load More Reviews
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- About Farmer Tab -->
                    <div class="tab-pane fade" id="farmer" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="farmer-profile-card">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <h5 class="mb-3">
                                                <i class="fas fa-user-tie text-primary me-2"></i>
                                                {{ product.farmer.farm_name }}
                                            </h5>
                                            
                                            {% if product.farmer.description %}
                                            <p class="mb-4">{{ product.farmer.description }}</p>
                                            {% endif %}
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6>Farm Details</h6>
                                                    <ul class="list-unstyled">
                                                        <li class="mb-2">
                                                            <i class="fas fa-map-marker-alt text-success me-2"></i>
                                                            {{ product.farmer.full_address }}
                                                        </li>
                                                        <li class="mb-2">
                                                            <i class="fas fa-expand-arrows-alt text-info me-2"></i>
                                                            Farm Size: {{ product.farmer.farm_size }} acres
                                                        </li>
                                                        <li class="mb-2">
                                                            <i class="fas fa-seedling text-success me-2"></i>
                                                            Type: {{ product.farmer.get_farm_type_display }}
                                                        </li>
                                                        {% if product.farmer.years_experience %}
                                                        <li class="mb-2">
                                                            <i class="fas fa-calendar text-primary me-2"></i>
                                                            Experience: {{ product.farmer.years_experience }} years
                                                        </li>
                                                        {% endif %}
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>Performance</h6>
                                                    <div class="mb-3">
                                                        {% if product.farmer.rating > 0 %}
                                                        <div class="d-flex align-items-center mb-2">
                                                            <div class="stars me-2">
                                                                {% for i in "12345"|make_list %}
                                                                    {% if forloop.counter <= product.farmer.rating %}
                                                                    <i class="fas fa-star text-warning"></i>
                                                                    {% else %}
                                                                    <i class="far fa-star text-warning"></i>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                            <span>{{ product.farmer.rating }}/5.0</span>
                                                        </div>
                                                        {% endif %}
                                                        <p class="small text-muted mb-2">
                                                            <i class="fas fa-comments me-2"></i>
                                                            {{ product.farmer.total_reviews }} review{{ product.farmer.total_reviews|pluralize }}
                                                        </p>
                                                        <p class="small text-muted mb-2">
                                                            <i class="fas fa-chart-line me-2"></i>
                                                            KSh {{ product.farmer.total_sales|floatformat:2 }} total sales
                                                        </p>
                                                        {% if product.farmer.is_verified %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-check-circle me-1"></i>Verified Farmer
                                                        </span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {% if product.farmer.certifications %}
                                            <div class="mt-4">
                                                <h6>Certifications</h6>
                                                <p class="text-muted">{{ product.farmer.certifications }}</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Contact Farmer</h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="mb-3">Get in touch with {{ product.farmer.farm_name }} directly</p>
                                        <div class="d-grid gap-2">
                                            <a href="https://wa.me/{{ product.farmer.mpesa_number|slice:'1:' }}?text=Hi! I saw your {{ product.name }} on AgriConnect. I'm interested to know more." 
                                               class="btn btn-success" target="_blank">
                                                <i class="fab fa-whatsapp me-2"></i>WhatsApp
                                            </a>
                                            <a href="tel:{{ product.farmer.user.phone_number }}" class="btn btn-outline-primary">
                                                <i class="fas fa-phone me-2"></i>Call
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Other Products</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="small text-muted mb-2">This farmer has more products available</p>
                                        <a href="{% url 'product_list' %}?farmer={{ product.farmer.id }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-store me-2"></i>View All Products
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Related Products -->
            {% if related_products %}
            <div class="related-products wow fadeInUp" data-wow-delay="0.7s">
                <h3 class="mb-4">Related Products</h3>
                <div class="row g-4">
                    {% for related_product in related_products %}
                    <div class="col-xl-3 col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="{{ forloop.counter0|floatformat:1|add:"0.1" }}s">
                        <div class="product-item">
                            <div class="position-relative bg-light overflow-hidden">
                                {% if related_product.main_image %}
                                    <img class="img-fluid w-100" src="{{ related_product.main_image.image.url }}" alt="{{ related_product.name }}" style="height: 250px; object-fit: cover;">
                                {% else %}
                                    <img class="img-fluid w-100" src="{% static 'img/product-placeholder.jpg' %}" alt="{{ related_product.name }}" style="height: 250px; object-fit: cover;">
                                {% endif %}
                                
                                <!-- Product badges -->
                                {% if related_product.is_organic %}
                                    <div class="bg-success rounded text-white position-absolute start-0 top-0 m-4 py-1 px-3">Organic</div>
                                {% elif related_product.is_featured %}
                                    <div class="bg-primary rounded text-white position-absolute start-0 top-0 m-4 py-1 px-3">Featured</div>
                                {% endif %}

                                <!-- Discount badge -->
                                {% if related_product.discount_percentage > 0 %}
                                    <div class="bg-danger rounded text-white position-absolute end-0 top-0 m-4 py-1 px-3">-{{ related_product.discount_percentage }}%</div>
                                {% endif %}
                            </div>
                            <div class="text-center p-4">
                                <a class="d-block h5 mb-2" href="{% url 'product_detail' related_product.slug %}">{{ related_product.name }}</a>
                                <div class="mb-2">
                                    <span class="text-primary me-1 fw-bold">KSh {{ related_product.selling_price|floatformat:2 }}</span>
                                    {% if related_product.discount_price %}
                                        <span class="text-body text-decoration-line-through">KSh {{ related_product.price|floatformat:2 }}</span>
                                    {% endif %}
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">{{ related_product.get_unit_display|upper }}</small>
                                    {% if related_product.subcategory %}
                                    <small class="text-muted"> | {{ related_product.subcategory.name }}</small>
                                    {% endif %}
                                    <small class="text-muted"> | {{ related_product.farmer.farm_name }}</small>
                                </div>
                                {% if related_product.short_description %}
                                <p class="text-muted small mt-2">{{ related_product.short_description|truncatechars:80 }}</p>
                                {% endif %}
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-map-marker-alt"></i> {{ related_product.farmer.county.name }}
                                    </small>
                                </div>
                            </div>
                            <div class="d-flex border-top">
                                <small class="w-50 text-center border-end py-2">
                                    <a class="text-body" href="{% url 'product_detail' related_product.slug %}">
                                        <i class="fa fa-eye text-primary me-2"></i>View Detail
                                    </a>
                                </small>
                                <small class="w-50 text-center py-2">
                                    {% if related_product.is_in_stock %}
                                        <a class="text-body" href="#" onclick="addToCart({{ related_product.id }})">
                                            <i class="fa fa-shopping-bag text-primary me-2"></i>Add to Cart
                                        </a>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fa fa-ban text-muted me-2"></i>Out of Stock
                                        </span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Frequently Bought Together -->
            {% if frequently_bought %}
            <div class="related-products wow fadeInUp" data-wow-delay="0.9s">
                <h3 class="mb-4">Frequently Bought Together</h3>
                <div class="row g-4">
                    {% for freq_product in frequently_bought %}
                    <div class="col-xl-3 col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="{{ forloop.counter0|floatformat:1|add:"0.1" }}s">
                        <div class="product-item">
                            <div class="position-relative bg-light overflow-hidden">
                                {% if freq_product.main_image %}
                                    <img class="img-fluid w-100" src="{{ freq_product.main_image.image.url }}" alt="{{ freq_product.name }}" style="height: 250px; object-fit: cover;">
                                {% else %}
                                    <img class="img-fluid w-100" src="{% static 'img/product-placeholder.jpg' %}" alt="{{ freq_product.name }}" style="height: 250px; object-fit: cover;">
                                {% endif %}
                                
                                <!-- Product badges -->
                                {% if freq_product.is_organic %}
                                    <div class="bg-success rounded text-white position-absolute start-0 top-0 m-4 py-1 px-3">Organic</div>
                                {% elif freq_product.is_featured %}
                                    <div class="bg-primary rounded text-white position-absolute start-0 top-0 m-4 py-1 px-3">Featured</div>
                                {% endif %}

                                <!-- Discount badge -->
                                {% if freq_product.discount_percentage > 0 %}
                                    <div class="bg-danger rounded text-white position-absolute end-0 top-0 m-4 py-1 px-3">-{{ freq_product.discount_percentage }}%</div>
                                {% endif %}
                            </div>
                            <div class="text-center p-4">
                                <a class="d-block h5 mb-2" href="{% url 'product_detail' freq_product.slug %}">{{ freq_product.name }}</a>
                                <div class="mb-2">
                                    <span class="text-primary me-1 fw-bold">KSh {{ freq_product.selling_price|floatformat:2 }}</span>
                                    {% if freq_product.discount_price %}
                                        <span class="text-body text-decoration-line-through">KSh {{ freq_product.price|floatformat:2 }}</span>
                                    {% endif %}
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">{{ freq_product.get_unit_display|upper }}</small>
                                    {% if freq_product.subcategory %}
                                    <small class="text-muted"> | {{ freq_product.subcategory.name }}</small>
                                    {% endif %}
                                    <small class="text-muted"> | {{ freq_product.farmer.farm_name }}</small>
                                </div>
                                {% if freq_product.short_description %}
                                <p class="text-muted small mt-2">{{ freq_product.short_description|truncatechars:80 }}</p>
                                {% endif %}
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-map-marker-alt"></i> {{ freq_product.farmer.county.name }}
                                    </small>
                                </div>
                            </div>
                            <div class="d-flex border-top">
                                <small class="w-50 text-center border-end py-2">
                                    <a class="text-body" href="{% url 'product_detail' freq_product.slug %}">
                                        <i class="fa fa-eye text-primary me-2"></i>View Detail
                                    </a>
                                </small>
                                <small class="w-50 text-center py-2">
                                    {% if freq_product.is_in_stock %}
                                        <a class="text-body" href="#" onclick="addToCart({{ freq_product.id }})">
                                            <i class="fa fa-shopping-bag text-primary me-2"></i>Add to Cart
                                        </a>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fa fa-ban text-muted me-2"></i>Out of Stock
                                        </span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Recently Viewed -->
            {% if recently_viewed %}
            <div class="related-products wow fadeInUp" data-wow-delay="1.1s">
                <h3 class="mb-4">Recently Viewed</h3>
                <div class="row g-4">
                    {% for recent_product in recently_viewed %}
                    <div class="col-xl-3 col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="{{ forloop.counter0|floatformat:1|add:"0.1" }}s">
                        <div class="product-item">
                            <div class="position-relative bg-light overflow-hidden">
                                {% if recent_product.main_image %}
                                    <img class="img-fluid w-100" src="{{ recent_product.main_image.image.url }}" alt="{{ recent_product.name }}" style="height: 250px; object-fit: cover;">
                                {% else %}
                                    <img class="img-fluid w-100" src="{% static 'img/product-placeholder.jpg' %}" alt="{{ recent_product.name }}" style="height: 250px; object-fit: cover;">
                                {% endif %}
                                
                                <!-- Product badges -->
                                {% if recent_product.is_organic %}
                                    <div class="bg-success rounded text-white position-absolute start-0 top-0 m-4 py-1 px-3">Organic</div>
                                {% elif recent_product.is_featured %}
                                    <div class="bg-primary rounded text-white position-absolute start-0 top-0 m-4 py-1 px-3">Featured</div>
                                {% endif %}

                                <!-- Discount badge -->
                                {% if recent_product.discount_percentage > 0 %}
                                    <div class="bg-danger rounded text-white position-absolute end-0 top-0 m-4 py-1 px-3">-{{ recent_product.discount_percentage }}%</div>
                                {% endif %}
                            </div>
                            <div class="text-center p-4">
                                <a class="d-block h5 mb-2" href="{% url 'product_detail' recent_product.slug %}">{{ recent_product.name }}</a>
                                <div class="mb-2">
                                    <span class="text-primary me-1 fw-bold">KSh {{ recent_product.selling_price|floatformat:2 }}</span>
                                    {% if recent_product.discount_price %}
                                        <span class="text-body text-decoration-line-through">KSh {{ recent_product.price|floatformat:2 }}</span>
                                    {% endif %}
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">{{ recent_product.get_unit_display|upper }}</small>
                                    {% if recent_product.subcategory %}
                                    <small class="text-muted"> | {{ recent_product.subcategory.name }}</small>
                                    {% endif %}
                                    <small class="text-muted"> | {{ recent_product.farmer.farm_name }}</small>
                                </div>
                                {% if recent_product.short_description %}
                                <p class="text-muted small mt-2">{{ recent_product.short_description|truncatechars:80 }}</p>
                                {% endif %}
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-map-marker-alt"></i> {{ recent_product.farmer.county.name }}
                                    </small>
                                </div>
                            </div>
                            <div class="d-flex border-top">
                                <small class="w-50 text-center border-end py-2">
                                    <a class="text-body" href="{% url 'product_detail' recent_product.slug %}">
                                        <i class="fa fa-eye text-primary me-2"></i>View Detail
                                    </a>
                                </small>
                                <small class="w-50 text-center py-2">
                                    {% if recent_product.is_in_stock %}
                                        <a class="text-body" href="#" onclick="addToCart({{ recent_product.id }})">
                                            <i class="fa fa-shopping-bag text-primary me-2"></i>Add to Cart
                                        </a>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fa fa-ban text-muted me-2"></i>Out of Stock
                                        </span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">{{ product.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="{{ product.name }}" class="img-fluid">
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification for cart actions -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="cartToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-shopping-cart text-success me-2"></i>
                <strong class="me-auto">Cart Update</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Product added to cart successfully!
            </div>
        </div>
    </div>

<script>
// Quantity controls
function increaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    const currentValue = parseInt(quantityInput.value);
    const maxValue = parseInt(quantityInput.max);
    
    if (currentValue < maxValue) {
        quantityInput.value = currentValue + 1;
        document.getElementById('form-quantity').value = quantityInput.value;
    }
}

function decreaseQuantity() {
    const quantityInput = document.getElementById('quantity');
    const currentValue = parseInt(quantityInput.value);
    const minValue = parseInt(quantityInput.min);
    
    if (currentValue > minValue) {
        quantityInput.value = currentValue - 1;
        document.getElementById('form-quantity').value = quantityInput.value;
    }
}

// Update form quantity when input changes
document.getElementById('quantity').addEventListener('input', function() {
    document.getElementById('form-quantity').value = this.value;
});

// Image gallery functionality
function changeMainImage(imageSrc, thumbnailElement) {
    document.getElementById('mainProductImage').src = imageSrc;
    
    // Remove active class from all thumbnails
    document.querySelectorAll('.thumbnail-img').forEach(img => {
        img.classList.remove('active');
    });
    
    // Add active class to clicked thumbnail
    thumbnailElement.classList.add('active');
}

// Image modal
function openImageModal(imageSrc) {
    document.getElementById('modalImage').src = imageSrc;
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
}

// Add to cart functionality with AJAX
document.querySelector('form[action*="add_to_cart"]').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        const toast = document.getElementById('cartToast');
        const toastMessage = document.getElementById('toastMessage');
        
        if (data.success) {
            toastMessage.textContent = data.message;
            toast.classList.remove('bg-danger');
            toast.classList.add('bg-success');
            
            // Update cart count if it exists
            const cartCount = document.querySelector('.cart-count');
            if (cartCount && data.cart_total) {
                cartCount.textContent = data.cart_total;
            }
        } else {
            toastMessage.textContent = data.message;
            toast.classList.remove('bg-success');
            toast.classList.add('bg-danger');
        }
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    })
    .catch(error => {
        console.error('Error:', error);
        const toast = document.getElementById('cartToast');
        const toastMessage = document.getElementById('toastMessage');
        toastMessage.textContent = 'An error occurred. Please try again.';
        toast.classList.add('bg-danger');
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    });
});

// Load more reviews functionality
function loadMoreReviews() {
    // Implementation for loading more reviews via AJAX
    console.log('Loading more reviews...');
}

// Add to cart for related products
function addToCart(productId) {
    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('quantity', 1);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/add-to-cart/${productId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        const toast = document.getElementById('cartToast');
        const toastMessage = document.getElementById('toastMessage');
        
        if (data.success) {
            toastMessage.textContent = data.message;
            toast.classList.remove('bg-danger');
            toast.classList.add('bg-success');
        } else {
            toastMessage.textContent = data.message;
            toast.classList.remove('bg-success');
            toast.classList.add('bg-danger');
        }
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
</script>

{% endblock %}